(function Minipush(){window.Minipush=window.Minipush||[];var _mp=window.Minipush;var isProcessingQueue=false,isInitialized=false,isSupported=false,isRegistered=false,isSubscribed=false,swRegistration=null,swSubscription=null,numVisits=0,lastDisclaimer=null,lastPermissionRequest=null;var debug,displayDisclaimer,displayDisclaimerDenied,displayBellButton;var checkBrowserSupport,getCookie,setCookie,getI18nMsg,getUrlVars,getUrlParam;var ready,init,initAutoBehaviours;var jsUrl,assetsUrl;var cfg={debug:false,version:"0.5",lastServiceWorkerVersion:"0.0.8",serverPublicKey:"BKqfdxes9cv6PeVdpz6iFEc1eomcj_Ttt3DjbUi9jTpqsLZMKvsCQpRmdfMtNXPhB7gAqCXkHkVK1UhB1weWFOU",serviceWorker:{url:'https://pushtide.com/minipush-client/sw/sw-0.0.8.js',oldUrl:'https://pushtide.com/minipush-client/sw/sw-0.0.8.js',},backend:{url:'https://pushtide.com/minipush-client/',refreshRate:1800,},autoSubscribe:true,client:{id:"",apiKey:"",publicKey:"",hostname:"",},localStorage:{appendDbId:true},cookies:{prefix:"",subscription:"pushtide-subscription",visits:"minipush-visit",disclaimer:"minipush-disclaimer",request:"minipush-request",},events:{onSubscribe:function(isAuto){debug.log("events.onSubscribe("+(isAuto?"true":"false")+")");}},autoBehaviour:{ask:null,granted:null,denied:null},permissionsRequest:{auto:{show:false,minVisits:3,cooldownTime:86400*7,fallbackToBellButton:false,onShow:function(){debug.log("permissionsRequest.auto.onShow()");},onSubscribe:function(){debug.log("permissionsRequest.auto.onSubscribe()");},onSubscribeError:function(){debug.log("permissionsRequest.auto.onSubscribeError()");}}},bellButton:{auto:{show:false,minVisits:2},cssTemplate:"#minipush-bell { position: fixed; /*border: 1px solid #ccc;*/ bottom: 50px; left: 50px; width: 50px; height: 50px; z-index: 99999;} .minipush-reset *{ font-size: medium; direction: ltr; text-align: left; text-align: start; font-family: \"open sans\", \"Helvetica Neue\", Helvetica, Arial, sans-serif; color: #000; font-style: normal; font-weight: 400; text-decoration: none; list-style-type: disc; box-sizing: border-box; margin: 0; outline:none; } #minipush-bell.minipush-bell-close .minipush-bell-deniedcontent {display:none;} #minipush-bell.minipush-bell-open .minipush-bell-deniedcontent {display:block;} #minipush-bell .minipush-bell-deniedcontent { position: absolute; left: 0; bottom: 65px; width: 300px; background-color: #F5F5F5; padding: 10px; border-radius: 4px; box-shadow: 2px 2px 0 rgba(0,0,0,.2); } #minipush-bell.minipush-bell-open .minipush-bell-deniedcontent:before { content: \" \"; display: block; width: 16px; height: 16px; background-color: #F5F5F5; position:absolute; bottom: -8px; left: 18px; transform: rotate(-45deg); box-shadow: 0 2px 0 rgba(0,0,0,.2); } #minipush-bell .minipush-bell-deniedcontent .minipush-bell-title { text-align: center; padding: 10px; border-bottom: 1px dashed #CCC; margin-bottom: 10px; font-size: 16px; } #minipush-bell .minipush-bell-deniedcontent .minipush-bell-text {font-size: 14px; line-height: 16px; margin-bottom: 10px; padding: 5px;} #minipush-bell.minipush-bell-open .minipush-bell-deniedcontent .minipush-bell-denied-image img { display:block; width:100%; height:auto; position: relative; } #minipush-bell .minipush-bell-icon { width: 50px; height: 50px; border-radius: 64px; /* box-shadow: 0 4px 2px rgba(0,0,0,.2);*/ filter: drop-shadow(0 2px 4px rgba(34,36,38,0.35)); -webkit-filter: drop-shadow(0 2px 4px rgba(34,36,38,0.35)); cursor: pointer; } #minipush-bell .minipush-bell-icon button { display:block; width:100%; height:100%; border:none; background:transparent; padding: 0; } #minipush-bell .minipush-bell-icon button img { display:block; width:100%; height:100%; } #minipush-bell .minipush-bell-message{ display:none; position: absolute; left: 60px; bottom: 8px; background-color: rgba(0,0,0,.85); border-radius: 3px; padding: 10px; } #minipush-bell .minipush-bell-message span{ display: block; font-size: 14px; line-height: 14px; min-width: 190px; color: #EEE; font-weight: bolder; overflow: hidden; text-overflow: ellipsis; } #minipush-bell:not(.minipush-bell-open).minipush-bell-hover .minipush-bell-message { display: inline-block; } #minipush-bell:not(.minipush-bell-open) #waves_x5F_left { /*animation: wave-pulse-left 2s linear infinite;*/ animation: bellshake-left 2s cubic-bezier(.36,.07,.19,.97) both infinite; backface-visibility: hidden; transform-origin: center; } #minipush-bell:not(.minipush-bell-open) #waves_x5F_right { animation: bellshake-right 2s cubic-bezier(.36,.07,.19,.97) both infinite; backface-visibility: hidden; transform-origin: center; } #minipush-bell:not(.minipush-bell-open) #clapper { animation: clapper-shake 2s cubic-bezier(.36, .07, .19, .97) both infinite; backface-visibility: hidden; transform-origin: center; } @keyframes bellshake-left { 0% { transform: rotate(0) scale(1); } 5% { transform: rotate(5deg) scale(1.2); } 10% { transform: rotate(-5deg); } 15% { transform: rotate(4deg) scale(1.15); } 20% { transform: rotate(-4deg); } 25% { transform: rotate(2deg) scale(1.1); } 28% { transform: rotate(-2deg); } 30% { transform: rotate(1deg); } 32% { transform: rotate(0) scale(1); } } @keyframes bellshake-right { 0% { transform: rotate(0) scale(1); } 5% { transform: rotate(-5deg) scale(1.2); } 10% { transform: rotate(5deg); } 15% { transform: rotate(-4deg) scale(1.15); } 20% { transform: rotate(4deg); } 25% { transform: rotate(-2deg) scale(1.1); } 28% { transform: rotate(2deg); } 30% { transform: rotate(-1deg); } 32% { transform: rotate(0) scale(1); } } @keyframes clapper-shake { 0% { transform: translateX(0); } 5% { transform: translateX(-5px); } 10% { transform: translateX(5px); } 15% { transform: translateX(-4px); } 20% { transform: translateX(4px); } 25% { transform: translateX(-2px); } 28% { transform: translateX(2px); } 30% { transform: translateX(1px); } 32% { transform: translateX(0); } } '",htmlTemplate:"<div id='minipush-bell' class='minipush-bell-{STATUS} minipush-bell-close minipush-reset'>"+
"   <div class='minipush-bell-icon'>"+
"       <button type='button' id='minipush-bell-button'>{ICON}</button>"+
"   </div>"+
"   <div class='minipush-bell-message'>"+
"       <span>{HOVERTEXT}</span>"+
"   </div>"+
"   <div class='minipush-bell-deniedcontent'>"+
"       <p class='minipush-bell-title'>{DENIEDTITLE}</p>"+
"       <p class='minipush-bell-text'>{DENIEDTEXT}</p>"+
"       <a href='{DENIEDIMAGE}' target='_blank' class='minipush-bell-denied-image'><img src='{DENIEDIMAGE}'></a>"+
"   </div>"+
"</div>",hoverText:{"default":"Subscribe to notifications","es":"Suscr√≠bete a nuestras notificaciones"},deniedHoverText:{"default":"You've blocked notifications","es":"Has bloqueado las notificaciones"},deniedTitle:{"default":"Unblock notifications","es":"Desbloquear notificaciones"},deniedText:{"default":"Follow these instructions to allow notifications","es":"Sigue estas instrucciones para activar las notificaciones"},deniedImage:{"default":"{ASSETS}bellButton/unblock_notification_es.png","chrome":"{ASSETS}bellButton/unblock_notification_es.png","firefox":"{ASSETS}bellButton/unblock_notification_es.png","safari":"{ASSETS}bellButton/unblock_notification_es.png","edge":"{ASSETS}bellButton/unblock_notification_es.png",},iconFillColor:'#18a689',icon:'<svg version="1.1" id="notifications_x5F_icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><style type="text/css">\t.st0{fill:#FFFFFF;} #color_x5F_bg{fill:{BELLICONBGCOLOR};}</style><circle id="color_x5F_bg" cx="50" cy="50" r="50"/><path id="bell_x5F_body" class="st0" d="M74.6,65.98l-8.16-15.12V35.77c0-7.56-5.12-13.92-12.07-15.83v-1.03\tc0-2.41-1.95-4.36-4.36-4.36c-2.41,0-4.36,1.95-4.36,4.36v1.03c-6.96,1.91-12.07,8.27-12.07,15.83v15.09L25.4,65.98\tc-0.96,1.78,0.33,3.93,2.34,3.93h5.82h12.8h7.26h12.8h5.82C74.27,69.91,75.56,67.76,74.6,65.98z"/><path id="clapper" class="st0" d="M42.58,73.69v2.63c0,3.94,3.2,7.13,7.14,7.13h0.56c3.94,0,7.14-3.19,7.14-7.13v-2.63H42.58z"/><g id="waves_x5F_left">\t<path class="st0" d="M20.15,60.06c-0.6,0-1.19-0.32-1.51-0.88c-3.28-5.74-1.27-13.08,4.47-16.35c0.83-0.47,1.89-0.18,2.36,0.65\t\tc0.48,0.83,0.18,1.89-0.65,2.36c-4.08,2.33-5.51,7.55-3.18,11.63c0.48,0.83,0.18,1.89-0.65,2.36\t\tC20.74,59.98,20.44,60.06,20.15,60.06z"/>\t<path class="st0" d="M13.97,63.58c-0.6,0-1.19-0.32-1.51-0.87c-2.53-4.43-3.18-9.58-1.84-14.5c1.35-4.92,4.53-9.02,8.96-11.55\t\tc0.83-0.47,1.89-0.18,2.36,0.65c0.48,0.83,0.18,1.89-0.65,2.36c-3.63,2.07-6.23,5.43-7.33,9.46c-1.1,4.03-0.57,8.24,1.5,11.87\t\tc0.48,0.83,0.18,1.89-0.65,2.37C14.56,63.5,14.26,63.58,13.97,63.58z"/></g><g id="waves_x5F_right">\t<path class="st0" d="M79.85,60.06c-0.29,0-0.58-0.08-0.85-0.23c-0.83-0.48-1.12-1.53-0.65-2.36c1.13-1.98,1.42-4.28,0.82-6.47\t\tc-0.6-2.2-2.02-4.03-4-5.15c-0.83-0.47-1.12-1.53-0.65-2.36c0.48-0.83,1.53-1.13,2.36-0.65c2.78,1.59,4.78,4.16,5.63,7.25\t\tc0.84,3.09,0.43,6.32-1.15,9.1C81.04,59.74,80.46,60.06,79.85,60.06z"/>\t<path class="st0" d="M86.02,63.58c-0.29,0-0.58-0.08-0.86-0.23c-0.83-0.48-1.12-1.53-0.65-2.37c2.07-3.63,2.6-7.84,1.5-11.87 c-1.1-4.03-3.7-7.39-7.33-9.46c-0.83-0.47-1.12-1.53-0.65-2.36c0.48-0.83,1.53-1.12,2.36-0.65c4.43,2.53,7.62,6.63,8.96,11.55 c1.35,4.92,0.69,10.07-1.83,14.5C87.21,63.26,86.63,63.58,86.02,63.58z"/></g></svg>',deniedIcon:'<svg version="1.1" id="notifications_x5F_icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><style type="text/css">\t.st0{fill:#FFFFFF;} #color_x5F_bg{fill:{BELLICONBGCOLOR};}</style><circle id="color_x5F_bg" cx="50" cy="50" r="50"/><path id="bell_x5F_body" class="st0" d="M74.6,65.98l-8.16-15.12V35.77c0-7.56-5.12-13.92-12.07-15.83v-1.03\tc0-2.41-1.95-4.36-4.36-4.36c-2.41,0-4.36,1.95-4.36,4.36v1.03c-6.96,1.91-12.07,8.27-12.07,15.83v15.09L25.4,65.98\tc-0.96,1.78,0.33,3.93,2.34,3.93h5.82h12.8h7.26h12.8h5.82C74.27,69.91,75.56,67.76,74.6,65.98z"/><path id="clapper" class="st0" d="M42.58,73.69v2.63c0,3.94,3.2,7.13,7.14,7.13h0.56c3.94,0,7.14-3.19,7.14-7.13v-2.63H42.58z"/><g id="waves_x5F_left">\t<path class="st0" d="M20.15,60.06c-0.6,0-1.19-0.32-1.51-0.88c-3.28-5.74-1.27-13.08,4.47-16.35c0.83-0.47,1.89-0.18,2.36,0.65\t\tc0.48,0.83,0.18,1.89-0.65,2.36c-4.08,2.33-5.51,7.55-3.18,11.63c0.48,0.83,0.18,1.89-0.65,2.36\t\tC20.74,59.98,20.44,60.06,20.15,60.06z"/>\t<path class="st0" d="M13.97,63.58c-0.6,0-1.19-0.32-1.51-0.87c-2.53-4.43-3.18-9.58-1.84-14.5c1.35-4.92,4.53-9.02,8.96-11.55\t\tc0.83-0.47,1.89-0.18,2.36,0.65c0.48,0.83,0.18,1.89-0.65,2.36c-3.63,2.07-6.23,5.43-7.33,9.46c-1.1,4.03-0.57,8.24,1.5,11.87\t\tc0.48,0.83,0.18,1.89-0.65,2.37C14.56,63.5,14.26,63.58,13.97,63.58z"/></g><g id="waves_x5F_right">\t<path class="st0" d="M79.85,60.06c-0.29,0-0.58-0.08-0.85-0.23c-0.83-0.48-1.12-1.53-0.65-2.36c1.13-1.98,1.42-4.28,0.82-6.47\t\tc-0.6-2.2-2.02-4.03-4-5.15c-0.83-0.47-1.12-1.53-0.65-2.36c0.48-0.83,1.53-1.13,2.36-0.65c2.78,1.59,4.78,4.16,5.63,7.25\t\tc0.84,3.09,0.43,6.32-1.15,9.1C81.04,59.74,80.46,60.06,79.85,60.06z"/>\t<path class="st0" d="M86.02,63.58c-0.29,0-0.58-0.08-0.86-0.23c-0.83-0.48-1.12-1.53-0.65-2.37c2.07-3.63,2.6-7.84,1.5-11.87 c-1.1-4.03-3.7-7.39-7.33-9.46c-0.83-0.47-1.12-1.53-0.65-2.36c0.48-0.83,1.53-1.12,2.36-0.65c4.43,2.53,7.62,6.63,8.96,11.55 c1.35,4.92,0.69,10.07-1.83,14.5C87.21,63.26,86.63,63.58,86.02,63.58z"/></g></svg>',},disclaimer:{auto:{show:false,minVisits:2,cooldownTime:86400*7,fallbackToBellButton:false,onShow:function(){debug.log("disclaimer.auto.onShow()");},onOKClick:function(isDeniedMode){debug.log("disclaimer.auto.onOKClick()");},onKOClick:function(isDeniedMode){debug.log("disclaimer.auto.onKOClick()");},onDeniedClick:function(){debug.log("disclaimer.auto.onDeniedClick()");},onSubscribe:function(){debug.log("disclaimer.auto.onSubscribe()");},onSubscribeError:function(){debug.log("disclaimer.auto.onSubscribeError()");}},destroyOnAck:true,destroyOnKO:true,title:{"default":"Do you want to receive our last updates?","es":"¬øQuieres recibir nuestras √∫ltimas novedades?"},text:{"default":"","es":""},deniedTitle:{"default":"Don't you want to receive our last updates?","es":"¬øNo quieres recibir nuestras √∫ltimas novedades?"},deniedText:{"default":"Please unblock our notifications!","es":"Desbloquea nuestras notificaciones ¬°Por favor!"},okButtonText:{"default":"Ok","es":"S√≠"},deniedOkButtonText:{"default":"Ok","es":"Vale"},koButtonText:{"default":"No thanks","es":"No gracias"},iconFillColor:'#18a689',cssTemplate:"#minipush-disclaimer { width: 450px; height: 150px; background-color: #FFF; border-radius: 5px; position: fixed; left: 50%; margin-left: -225px; top: 100px; box-shadow: 0 2px 0 rgba(0,0,0,.15); border: 1px solid #EEE; overflow: hidden; } .minipush-reset * { font-size: medium; line-height: 1; direction: ltr; text-align: left; text-align: start; font-family: \"open sans\", \"Helvetica Neue\", Helvetica, Arial, sans-serif; color: #000; font-style: normal; font-weight: 400; text-decoration: none; list-style-type: disc; box-sizing: border-box; margin: 0; } #minipush-disclaimer button { display: inline-block; color: #FFF; background-color: {ICONFILLCOLOR}; padding: 12px 18px; font-size: 14px; font-weight: bold; line-height: 14px; border: none; border-radius: 5px; cursor:pointer; text-transform: uppercase; border: 1px solid {ICONFILLCOLOR}; } #minipush-disclaimer button:hover { background-color: {ICONFILLCOLOR}; opacity: .8; border-color: {ICONFILLCOLOR}; } #minipush-disclaimer button.outline { color: #999; background-color: transparent; border: 1px solid #999; } #minipush-disclaimer button.outline:hover { background-color: rgba(100,100,100,.1); } .minipush-disclaimer-thumbnail, .minipush-disclaimer-content { display: inline-block; vertical-align: middle; } .minipush-disclaimer-thumbnail { padding: 30px 15px; background-color: {ICONFILLCOLOR}; } .minipush-disclaimer-thumbnail img { width: 90px; height: 90px; } .minipush-disclaimer-content { width: 330px; height: 100%; padding: 15px; background-color: #FBFBFB; border-radius: 0 5px 5px 0; } .minipush-disclaimer-content p, .minipush-disclaimer-content h2 { display: block; } .minipush-disclaimer-content .minipush-disclaimer-title, .minipush-disclaimer-content .minipush-disclaimer-text { max-width: 100%; text-overflow: ellipsis; margin-bottom: 12px; text-align: center; } .minipush-disclaimer-content .minipush-disclaimer-title { font-size: 14px; line-height: 18px; margin-top: 10px; font-weight: bold; text-transform: uppercase; color: #676a6c; } .minipush-disclaimer-content .minipush-disclaimer-text { font-size: 13px; color: #999; } .minipush-disclaimer-buttons { text-align: right; position: absolute; bottom: 15px; right: 15px; } .minipush-disclaimer-buttons button:not(:first-of-type){ margin-left: 10px; }",htmlTemplate:"<div id='minipush-disclaimer' class='minipush-modal-ask minipush-reset'>"+
"<div class='minipush-disclaimer-thumbnail'><img class='minipush-disclaimer-icon' src='{DISCLAIMERICON}'/></div>"+
"<div class='minipush-disclaimer-content'><p class='minipush-disclaimer-title'>{TITLE}</p><p class='minipush-disclaimer-text'>{TEXT}</p>"+
"<div class='minipush-disclaimer-buttons'>"+
"<button id='minipush-do-ko' type='button' class='minipush-callbackKO outline'>{KOBUTTONTEXT}</button>"+
"<button id='minipush-do-ok' type='button' class='minipush-callbackOK'>{OKBUTTONTEXT}</button>"+
"</div>"+
"</div>"+
"</div>",deniedHtmlTemplate:"<div id='minipush-disclaimer' class='minipush-modal-denied minipush-reset'>"+
"<div class='minipush-disclaimer-thumbnail'><img class='minipush-disclaimer-icon' src='{DISCLAIMERICON}'/></div>"+
"<div class='minipush-disclaimer-content'>"+
"<p class='minipush-disclaimer-title'>{TITLE}</p>"+
"<p class='minipush-disclaimer-text'>{TEXT}</p>"+
"<div class='minipush-disclaimer-buttons'>"+
"<button id='minipush-do-ok' type='button' class='minipush-callbackOK'>{OKBUTTONTEXT}</button>"+
"</div>"+
"</div>"+
"</div>",containerElement:null,icon:"{ASSETS}disclaimer/disclaimer_icon_ecommerce.png",deniedIcon:"{ASSETS}disclaimer/disclaimer_icon_blocked.png",}};var minipushSubscription=null;_mp.push=function(){var retValue=Array.prototype.push.apply(this,arguments);if(isSupported){processQueue();}
return retValue;};_mp.numVisits=function(){return numVisits;};_mp.deleteCookies=function(){setCookie(cfg.cookies.prefix+cfg.cookies.subscription,null,null,-1);setCookie(cfg.cookies.prefix+cfg.cookies.visits,null,null,-1);setCookie(cfg.cookies.prefix+cfg.cookies.disclaimer,null,null,-1);setCookie(cfg.cookies.prefix+cfg.cookies.request,null,null,-1);};_mp.setCookie=function(cookieName,cookieValue,domain,days){setCookie(cookieName,cookieValue,domain,days);};_mp.lastDisclaimerSeconds=function(){if(lastDisclaimer==null){return null;}else{var diff=(new Date()).getTime()-lastDisclaimer.getTime();return Math.floor((diff/1000));}};_mp.lastDisclaimerDays=function(){if(lastDisclaimer==null){return null;}else{var diff=(new Date()).getTime()-lastDisclaimer.getTime();return Math.floor((diff/1000)/86400);}};_mp.lastPermissionRequestSeconds=function(){if(lastPermissionRequest==null){return null;}else{var diff=(new Date()).getTime()-lastPermissionRequest.getTime();return Math.floor((diff/1000));}};_mp.lastPermissionRequestDays=function(){if(lastPermissionRequest==null){return null;}else{var diff=(new Date()).getTime()-lastPermissionRequest.getTime();return Math.floor((diff/1000)/86400);}};_mp.isReady=function(){return isInitialized;};_mp.isSupported=function(){return isSupported;};_mp.isRegistered=function(){return(isInitialized&&isSupported&&isRegistered);};_mp.isSubscribed=function(){return(isInitialized&&isSupported&&isSubscribed);};_mp.isBlocked=function(){return _mp.notificationsBlocked();};_mp.notificationsGranted=function(){return isSupported&&Notification.permission==="granted";};_mp.notificationsBlocked=function(){return isSupported&&Notification.permission==="denied";};_mp.swRegistration=function(){return swRegistration;};_mp.swSubscription=function(){return swSubscription;};_mp.getSettings=function(){return cfg;};_mp.setSettings=function(propertiesAndValues,parent){var root=false;if(parent==undefined){parent=cfg;root=true;cfg.client.hostname=window.location.hostname;}
let newSettings={};let hasNewSettings=false;if(typeof propertiesAndValues=="object"){for(var propertyKey in propertiesAndValues){hasNewSettings=true;if(typeof parent[propertyKey]!="undefined"&&parent[propertyKey]instanceof Object&&!(parent[propertyKey]instanceof Array)){if(Object.prototype.toString.call(propertiesAndValues[propertyKey])=="[object Object]"){newSettings[propertyKey]=_mp.setSettings(propertiesAndValues[propertyKey],parent[propertyKey]);}else{newSettings[propertyKey]=propertiesAndValues[propertyKey];parent[propertyKey]=propertiesAndValues[propertyKey];}}else{newSettings[propertyKey]=propertiesAndValues[propertyKey];parent[propertyKey]=propertiesAndValues[propertyKey];}}}else{hasNewSettings=true;parent=propertiesAndValues;newSettings=parent;}
if(cfg.client.publicKey.length==0)cfg.client.publicKey=cfg.client.apiKey;if(hasNewSettings&&root){debug.log("New settings object: ",newSettings);}
if(getUrlParam("minipushDebug",false)){cfg.debug=true;}
return newSettings;};_mp.subscription={setId:function(id){return minipushSubscription.setId(id);},getId:function(){return minipushSubscription.getId();},dumpUid:function(){minipushSubscription.getUid().then(function(uid){if(typeof console!="undefined"){console.log("SUBSCRIPTION UID >>>> "+uid);}}).catch(function(e){debug.error("Unable to get uid: "+e);});},getUid:function(){return minipushSubscription.getUid();},getSubscriptionData:function(){return minipushSubscription.getSubscriptionData();},printUid:function(){minipushSubscription.printUid();},setData:function(data){return minipushSubscription.setData(data);},getData:function(){return minipushSubscription.getData();},setTags:function(tags){return minipushSubscription.setTags(tags);},addTags:function(tags){return minipushSubscription.addTags(tags);},removeTags:function(tags){return minipushSubscription.removeTags(tags);},removeTagsByPrefix:function(tags){return minipushSubscription.removeTagsByPrefix(tags);},replaceTags:function(tags){return minipushSubscription.replaceTags(tags);},hasTag:function(tag){return minipushSubscription.hasTag(tag);},getTags:function(){return minipushSubscription.getTags();},getBaseTags:function(){return minipushSubscription.getBaseTags();},displayBellButton:function(){return displayBellButton();},displayDisclaimer:function(onOKClick,onKOClick,onDeniedClick,onReady){return displayDisclaimer(onOKClick,onKOClick,onDeniedClick,onReady);},subscribe:function(force){if(force==undefined)force=false;return new Promise(function(resolve,reject){sw.subscribe(force).then(function(subscription){if(isSubscribed){setTimeout(function(){resolve(subscription);},1000);}else{reject(new MinipushError("unable-to-subscribe",new Error("Unknown error. It seems to have subscribed but it's not set as subscribed")));}}).catch(function(e){reject(e);});});},unsubscribe:function(){return new Promise(function(resolve,reject){sw.unsubscribe().then(function(){if(!isSubscribed){setTimeout(function(){resolve();},1000);}else{reject(new MinipushError("unable-to-unsubscribe",new Error("Unknown error. It seems to have unsubscribed but it set as subscribed")));}}).catch(function(e){reject(e);});});},showNotification:function(title,options){return sw.showNotification(title,options);}};var getClientLang=function(){var clientLang=navigator.language.toLowerCase();if(clientLang.indexOf("-")>-1)clientLang=clientLang.split("-")[0];return clientLang;};var getClientBrowser=function(){var isOpera=(!!window.opr&&!!opr.addons)||!!window.opera||navigator.userAgent.indexOf(' OPR/')>=0;var isFirefox=typeof InstallTrigger!=='undefined';var isSafari=/constructor/i.test(window.HTMLElement)||(function(p){return p.toString()==="[object SafariRemoteNotification]";})(!window['safari']||safari.pushNotification);var isIE=false||!!document.documentMode;var isEdge=!isIE&&!!window.StyleMedia;var isChrome=!!window.chrome&&!!window.chrome.webstore;var isBlink=(isChrome||isOpera)&&!!window.CSS;return isOpera?'opera':isFirefox?'firefox':isSafari?'safari':isChrome?'chrome':isEdge?'edge':isBlink?'blink':"chrome";};var bellButtonMarkup;var bellButtonOpen;displayBellButton=function(){if(isSubscribed){debug.log("User already subscribed, skipping displayBellButton()");return false;}
if(Notification.permission==="granted"){debug.log("Permissions already granted, autosubscribing and skipping displayBellButton()");window.Minipush.subscription.subscribe().then(function(){}).catch(function(){});return false;}
bellButtonOpen=false;if(!isSubscribed&&!bellButtonMarkup){var bellButtonHTML,clientLang,clientBrowser,status;clientLang=getClientLang();clientBrowser=getClientBrowser();status=Notification.permission=="denied"?"denied":"ask";var bellButtonCSSWrapper=document.getElementById("minipush-bell-css");if(bellButtonCSSWrapper)bellButtonCSSWrapper.remove();bellButtonCSSWrapper=document.createElement('style');bellButtonCSSWrapper.id="minipush-bell-css";bellButtonCSSWrapper.innerHTML=cfg.bellButton.cssTemplate;document.head.prepend(bellButtonCSSWrapper);bellButtonHTML=cfg.bellButton.htmlTemplate;bellButtonHTML=bellButtonHTML.split("{STATUS}").join(status);bellButtonHTML=bellButtonHTML.split("{ICON}").join(getI18nMsg(status=="denied"?cfg.bellButton.deniedIcon:cfg.bellButton.icon,clientBrowser));bellButtonHTML=bellButtonHTML.split("{BELLICONBGCOLOR}").join(cfg.bellButton.iconFillColor);bellButtonHTML=bellButtonHTML.split("{HOVERTEXT}").join(getI18nMsg(status=="denied"?cfg.bellButton.deniedHoverText:cfg.bellButton.hoverText,clientLang));bellButtonHTML=bellButtonHTML.split("{DENIEDTITLE}").join(getI18nMsg(cfg.bellButton.deniedTitle,clientLang));bellButtonHTML=bellButtonHTML.split("{DENIEDTEXT}").join(getI18nMsg(cfg.bellButton.deniedText,clientLang));bellButtonHTML=bellButtonHTML.split("{DENIEDIMAGE}").join(getI18nMsg(cfg.bellButton.deniedImage,clientBrowser));bellButtonHTML=bellButtonHTML.split("{ASSETS}").join(assetsUrl);var bellButtonMarkupWrapper=document.createElement('div');bellButtonMarkupWrapper.innerHTML=bellButtonHTML.trim();bellButtonMarkup=bellButtonMarkupWrapper.firstChild;if(cfg.bellButton.containerElement instanceof HTMLElement){cfg.bellButton.containerElement.appendChild(bellButtonMarkup);}else{document.body.appendChild(bellButtonMarkup);}
var bellElement=document.getElementById("minipush-bell");var closeBellButton=function(){bellButtonOpen=false;debug.log("Close bellButton");bellElement.classList.add("minipush-bell-close");bellElement.classList.remove("minipush-bell-open");}
var openBellButton=function(){debug.log("Open bellButton");bellButtonOpen=true;bellElement.classList.remove("minipush-bell-close");bellElement.classList.add("minipush-bell-open");}
document.body.addEventListener('click',function(e){if(bellButtonOpen){closeBellButton();}});bellButtonMarkup.addEventListener('click',function(e){e.stopPropagation();if(bellButtonOpen){closeBellButton();}else{if(Notification.permission==="denied"){openBellButton();}else{debug.log("Suscribe");window.Minipush.subscription.subscribe().then(function(){bellButtonMarkup.remove();});}}});bellButtonMarkup.addEventListener('mouseover',function(e){e.stopPropagation();bellElement.classList.add("minipush-bell-hover");});bellButtonMarkup.addEventListener('mouseout',function(e){e.stopPropagation();bellElement.classList.remove("minipush-bell-hover");});return true;}
return false;};var disclaimerMarkup;displayDisclaimer=function(onOKClick,onKOClick,onDeniedClick,onReady){lastDisclaimer=new Date();setCookie(cfg.cookies.prefix+cfg.cookies.disclaimer,lastDisclaimer.getTime(),null,90);return new Promise(function(resolve,reject){var disclaimerHTML,title,text,textOK,textKO,clientLang;if(isSubscribed){debug.log("User already subscribed, skipping displayDisclaimer()");resolve();return;}
if(Notification.permission==="granted"){window.Minipush.subscription.subscribe().then(function(){resolve();}).catch(function(){reject();});return;}
clientLang=getClientLang();var disclaimerCSSWrapper=document.getElementById("minipush-disclaimer-css");if(disclaimerCSSWrapper)disclaimerCSSWrapper.remove();disclaimerCSSWrapper=document.createElement('style');disclaimerCSSWrapper.id="minipush-disclaimer-css";disclaimerCSSWrapper.innerHTML=cfg.disclaimer.cssTemplate.split("{ICONFILLCOLOR}").join(cfg.disclaimer.iconFillColor);document.body.appendChild(disclaimerCSSWrapper);disclaimerHTML=cfg.disclaimer.htmlTemplate;disclaimerHTML=disclaimerHTML.split("{DISCLAIMERICON}").join(getI18nMsg(cfg.disclaimer.icon,getClientBrowser()));title=getI18nMsg(cfg.disclaimer.title,clientLang);text=getI18nMsg(cfg.disclaimer.text,clientLang);textOK=getI18nMsg(cfg.disclaimer.okButtonText,clientLang);textKO=getI18nMsg(cfg.disclaimer.koButtonText,clientLang);var disclaimerMarkupWrapper=document.createElement('div');disclaimerHTML=disclaimerHTML.split("{TITLE}").join(title);disclaimerHTML=disclaimerHTML.split("{TEXT}").join(text);disclaimerHTML=disclaimerHTML.split("{OKBUTTONTEXT}").join(textOK);disclaimerHTML=disclaimerHTML.split("{KOBUTTONTEXT}").join(textKO);disclaimerHTML=disclaimerHTML.split("{ASSETS}").join(assetsUrl);disclaimerMarkupWrapper.innerHTML=disclaimerHTML.trim();disclaimerMarkup=disclaimerMarkupWrapper.firstChild;if(cfg.disclaimer.containerElement instanceof HTMLElement){cfg.disclaimer.containerElement.appendChild(disclaimerMarkup);}else{document.body.appendChild(disclaimerMarkup);}
disclaimerMarkup.addEventListener('click',function(e){if(e.target&&e.target.id==='minipush-do-ok'){e.stopPropagation();if(Notification.permission==="denied"){disclaimerMarkup.remove();displayDisclaimerDenied(onDeniedClick);}else{window.Minipush.subscription.subscribe().then(function(){if(cfg.disclaimer.destroyOnAck){disclaimerMarkup.remove();}
resolve();}).catch(function(){reject();});}
if(typeof onOKClick==="function"){onOKClick(Notification.permission==="denied");}}
if(e.target&&e.target.id==='minipush-do-ko'){e.stopPropagation();if(cfg.disclaimer.destroyOnKO){disclaimerMarkup.remove();}
if(typeof onKOClick==="function"){onKOClick(Notification.permission==="denied");}}});if(typeof onReady==="function"){onReady();}});};displayDisclaimerDenied=function(onDeniedClick){var disclaimerHTML,title,text,textOK,textKO,clientLang;clientLang=getClientLang();disclaimerHTML=cfg.disclaimer.deniedHtmlTemplate;disclaimerHTML=disclaimerHTML.split("{DISCLAIMERICON}").join(getI18nMsg(cfg.disclaimer.deniedIcon,getClientBrowser()));title=getI18nMsg(cfg.disclaimer.deniedTitle,clientLang);text=getI18nMsg(cfg.disclaimer.deniedText,clientLang);textOK=getI18nMsg(cfg.disclaimer.deniedOkButtonText,clientLang);textKO=getI18nMsg(cfg.disclaimer.koButtonText,clientLang);var disclaimerMarkupWrapper=document.createElement('div');disclaimerHTML=disclaimerHTML.split("{TITLE}").join(title);disclaimerHTML=disclaimerHTML.split("{TEXT}").join(text);disclaimerHTML=disclaimerHTML.split("{OKBUTTONTEXT}").join(textOK);disclaimerHTML=disclaimerHTML.split("{KOBUTTONTEXT}").join(textKO);disclaimerHTML=disclaimerHTML.split("{ASSETS}").join(assetsUrl);disclaimerMarkupWrapper.innerHTML=disclaimerHTML.trim();disclaimerMarkup=disclaimerMarkupWrapper.firstChild;if(cfg.disclaimer.containerElement instanceof HTMLElement){cfg.disclaimer.containerElement.appendChild(disclaimerMarkup);}else{document.body.appendChild(disclaimerMarkup);}
disclaimerMarkup.addEventListener('click',function(e){if(e.target&&e.target.id==='minipush-do-ok'){e.stopPropagation();if(cfg.disclaimer.destroyOnAck){disclaimerMarkup.remove();}
if(typeof onDeniedClick==="function"){onDeniedClick();}}});};debug={log:function(msg,debugObject){if(cfg.debug&&typeof console!="undefined"){if(debugObject!=undefined){console.log("%cüåä Minipush "+Date.now()+": %c"+msg,"color:#50B","color:#666",debugObject);}else{console.log("%cüåä Minipush "+Date.now()+": %c"+msg,"color:#50B","color:#666");}}},warn:function(msg){if(cfg.debug&&typeof console!="undefined"){console.warn("%cüåä Minipush "+Date.now()+": %c"+msg,"color:#50B","color:#666");}},error:function(errorMsg){if(typeof console!="undefined"){console.error("%cüåä Minipush "+Date.now()+": %c"+errorMsg,"color:#50B","color:#f66");}}};initAutoBehaviours=function(){if(!isSubscribed){processQueue();var shown=false;var permissionVar=Notification.permission;if(permissionVar=="default")permissionVar="ask";var autoBehaviour=cfg.autoBehaviour.hasOwnProperty(permissionVar)?cfg.autoBehaviour[permissionVar]:null;if(autoBehaviour&&cfg.hasOwnProperty(autoBehaviour)&&cfg[autoBehaviour].hasOwnProperty("auto")){cfg[autoBehaviour].auto.show=true;debug.log("ü§ñ >>> Activated "+autoBehaviour+" behaviour for permission state: "+permissionVar);}
if(cfg.permissionsRequest.auto.show==true){if(numVisits>=cfg.permissionsRequest.auto.minVisits&&(lastPermissionRequest==null||_mp.lastPermissionRequestSeconds()>cfg.permissionsRequest.auto.cooldownTime)){shown=true;debug.log("ü§ñ >>> Trigger permissionsRequest autobehaviour");if(Notification.permission!="denied"){_mp.subscription.subscribe(false).then(cfg.permissionsRequest.auto.onSubscribe).catch(cfg.permissionsRequest.auto.onSubscribeError);cfg.permissionsRequest.auto.onShow(true);}else{debug.log("ü§ñ >>> Falling back to bellButton autobehaviour for blocked permissions");cfg.bellButton.auto.show=true;cfg.permissionsRequest.auto.onShow(false);}}else{if(cfg.disclaimer.auto.fallbackToBellButton){debug.log("ü§ñ >>> Falling back to bellButton autobehaviour");cfg.bellButton.auto.show=true;cfg.permissionsRequest.auto.onShow(false);}}}
if(!shown&&cfg.disclaimer.auto.show==true){if(numVisits>=cfg.disclaimer.auto.minVisits&&(lastDisclaimer==null||_mp.lastDisclaimerSeconds()>cfg.disclaimer.auto.cooldownTime)){debug.log("ü§ñ >>> Trigger disclaimer autobehaviour");_mp.subscription.displayDisclaimer(cfg.disclaimer.auto.onOKClick,cfg.disclaimer.auto.onKOClick,cfg.disclaimer.auto.onDeniedClick).then(cfg.disclaimer.auto.onSubscribe).catch(cfg.disclaimer.auto.onSubscribeError);cfg.disclaimer.auto.onShow();}else{if(cfg.disclaimer.auto.fallbackToBellButton){debug.log("ü§ñ >>> Falling back to bellButton autobehaviour");cfg.bellButton.auto.show=true;}}}
if(cfg.bellButton.auto.show==true){if(numVisits>=cfg.bellButton.auto.minVisits){debug.log("ü§ñ >>> Trigger bellbutton autobehaviour");_mp.subscription.displayBellButton();}}}};ready=function(){if(isSupported){if(minipushSubscription)minipushSubscription.ready(swSubscription);if(!isSubscribed&&Notification.permission=="granted"&&cfg.autoSubscribe){debug.log("Permissions already granted, trying to autosubscribe to push messaging...");sw.subscribe(false,true).then(function(subscription){debug.log("Autosubscription completed successfully");initAutoBehaviours();}).catch(function(e){debug.error("Cannot autosubscribe "+e);initAutoBehaviours();});}else{if(isSubscribed&&swRegistration){navigator.serviceWorker.ready.then(function(reg){debug.log("Updating service worker config");sw.sendConfigEvent();});}
initAutoBehaviours();}
processQueue();setInterval(processQueue,1000);if(getUrlParam("minipushDebugSubscription",false)){setTimeout(function(){minipushSubscription.getSubscriptionData().then(function(subscriptionData){if(subscriptionData){var output="";for(var k in subscriptionData){output+="\n"+k+": "+JSON.stringify(subscriptionData[k]);}
alert("SUBSCRIPTION DATA: "+output)
if(typeof console!="undefined")console.log("SUBSCRIPTION DATA: "+output);}else{alert("No subscription");}});},3000);}
if(getUrlParam("minipushDebugTags",false)){setTimeout(function(){minipushSubscription.getSubscriptionData().then(function(subscriptionData){if(subscriptionData){var output=JSON.stringify(subscriptionData.client_tags);alert("SUBSCRIPTION TAGS: "+output)
if(typeof console!="undefined")console.log("SUBSCRIPTION TAGS: "+output);}else{alert("SUBSCRIPTION TAGS: Not subscribed to notifications")}});},2000);}
if(getUrlParam("minipushTest",null)!==null){var value=getUrlParam("minipushTest",null);if(value=="1"||value=="true"||value===""){debug.log("Automatically adding test tag");minipushSubscription.addTags(["push-test"]);}else{debug.log("Automatically removing test tag");minipushSubscription.removeTags(["push-test"]);}}
if(getUrlParam("minipushAddTag",false)){debug.log("Automatically adding tag "+getUrlParam("minipushAddTag",false));minipushSubscription.addTags([getUrlParam("minipushAddTag",false)]);}
if(getUrlParam("minipushRemoveTag",false)){debug.log("Automatically removing tag "+getUrlParam("minipushRemoveTag",false));minipushSubscription.removeTags([getUrlParam("minipushRemoveTag",false)]);}}else{processQueue();}};init=function(){if(!isInitialized){var scripts=document.getElementsByTagName("script");for(var i=0;i<scripts.length;i++){if(scripts[i].getAttribute('src')&&scripts[i].getAttribute('src').match(/minipush-client\/minipush\/[a-zA-Z0-9_\-\.]+\.js/i)){jsUrl=scripts[i].getAttribute('src');assetsUrl=jsUrl;assetsUrl=assetsUrl.substring(0,assetsUrl.lastIndexOf("/"));assetsUrl=assetsUrl.substring(0,assetsUrl.lastIndexOf("/")+1);assetsUrl+="assets/";}}
if(window.hasOwnProperty("MinipushSettings")){_mp.setSettings(window.MinipushSettings);}else{_mp.setSettings({});}
preProcessQueue();if(getUrlParam("minipushDebug",false))_mp.setSettings({debug:true});checkBrowserSupport();isInitialized=true;isSubscribed=false;if(isSupported){let visitCookie=getCookie(cfg.cookies.prefix+cfg.cookies.visits);if(visitCookie!=""&&visitCookie!=NaN)numVisits=parseInt(visitCookie,10);if(isNaN(numVisits)||numVisits<0)numVisits=0;numVisits++;setCookie(cfg.cookies.prefix+cfg.cookies.visits,numVisits+"",null,90);let lastDisclaimerCookie=getCookie(cfg.cookies.prefix+cfg.cookies.disclaimer);if(lastDisclaimerCookie!=null&&lastDisclaimerCookie!=""){try{lastDisclaimer=new Date();lastDisclaimer.setTime(lastDisclaimerCookie);}catch(e){lastDisclaimer=null;}}
let lastPermissionRequestCookie=getCookie(cfg.cookies.prefix+cfg.cookies.request);if(lastPermissionRequestCookie!=null&&lastPermissionRequestCookie!=""){try{lastPermissionRequest=new Date();lastPermissionRequest.setTime(lastPermissionRequestCookie);}catch(e){lastPermissionRequest=null;}}
minipushSubscription=new MinipushSubscription(_mp,cfg);sw.getSubscription().finally(function(){debug.log("-----------------------");debug.log("Initialized...");debug.log("Supported: true");debug.log("Registered: "+(isRegistered?"true":"false"));debug.log("Subscribed: "+(isSubscribed?"true":"false"));debug.log("NumVisits: "+numVisits);debug.log("LastDisclaimer: "+_mp.lastDisclaimerSeconds());debug.log("LastPermissionRequest: "+_mp.lastPermissionRequestSeconds());debug.log("JS Url: "+jsUrl);debug.log("ASSETS Url: "+assetsUrl);debug.log("-----------------------")
if(isRegistered&&swRegistration.active.scriptURL!=cfg.serviceWorker.url){debug.warn("WARNING: SERVICE WORKER URL HAS CHANGED!");debug.log("Old: "+swRegistration.active.scriptURL);debug.log("New: "+cfg.serviceWorker.url);debug.log("-----------------------");handleServiceWorkerUrlChange(function(){ready();});}else{ready();}});}else{setCookie(cfg.cookies.prefix+cfg.cookies.subscription,null,null,-1);debug.log("-----------------------");debug.log("Initialized... Settings: ",cfg);debug.log("Supported: false");debug.log("-----------------------");ready();}}};var handleServiceWorkerUrlChange=function(onComplete){swRegistration.unregister().finally(function(){navigator.serviceWorker.ready.then(function(reg){swRegistration=null;sw.sendEvent("unregister-sw");isRegistered=false;if(isSubscribed){sw.subscribe(true,true,swSubscription?swSubscription.endpoint:null).finally(function(){onComplete();});}else{onComplete();}});});};var preProcessQueue=function(){if(typeof _mp!="undefined"&&_mp.length>0){debug.log("Preprocessing queue items: "+_mp.length);for(var idx=0;idx<_mp.length;idx++){if(_mp[idx]instanceof Array){var arr=_mp[idx].slice(),command=arr.shift();processQueueCommand(command,arr,true);}}}};var processQueue=function(){if(isInitialized&&!isProcessingQueue){if(typeof _mp!="undefined"&&_mp.length>0){isProcessingQueue=true;debug.log("Processing queue items: "+_mp.length);for(var idx=0;idx<_mp.length;idx++){if(typeof(_mp[idx])=="function"){_mp[idx]();}else if(_mp[idx]instanceof Array){var arr=_mp[idx].slice(),command=arr.shift();processQueueCommand(command,arr,false);}}
_mp.length=0;isProcessingQueue=false;}}};var processQueueCommand=function(command,args,preProcessMode){if(args==undefined)args=[];if(!preProcessMode)debug.log("Process queue command "+command);if(command=="settings"){_mp.setSettings(args[0]);};if(!preProcessMode){if(command=="setData"){if(minipushSubscription){minipushSubscription.setData(args[0]);}}
if(command=="setTags"){if(minipushSubscription){minipushSubscription.setTags(args[0]);}}
if(command=="addTags"){if(minipushSubscription){minipushSubscription.addTags(args[0]);}}
if(command=="removeTags"){if(minipushSubscription){minipushSubscription.removeTags(args[0]);}}
if(command=="removeTagsByPrefix"){if(minipushSubscription){minipushSubscription.removeTagsByPrefix(args[0]);}}
if(command=="replaceTags"){if(minipushSubscription){minipushSubscription.replaceTags(args[0]);}}
if(command=="setId"){if(minipushSubscription){minipushSubscription.setId(args[0]);}}}
return false;};checkBrowserSupport=function(){isSupported=typeof navigator!="undefined"&&typeof navigator.serviceWorker!="undefined"&&navigator.serviceWorker!=null&&typeof Notification!="undefined"&&Notification!=null&&typeof Promise!=="undefined"&&typeof window.localStorage!=="undefined";};setCookie=function(cookieName,cookieValue,domain,days){if(domain===undefined||domain===null){domain=window.location.hostname;}
document.cookie=cookieName+'=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/; domain='+domain;if(days<0)return;var exdate=new Date();if(days>=1){exdate.setDate(exdate.getDate()+days);}else{var now=new Date();var time=now.getTime();time+=3600*1000*Math.floor(24*days);exdate.setTime(time);}
cookieValue=encodeURI(cookieValue)+((days===null)?"":"; expires="+exdate.toGMTString());cookieValue+="; path=/; domain="+domain;document.cookie=cookieName+"="+cookieValue;};getCookie=function(cookieName){var c_end;var c_value=document.cookie;var c_start=c_value.indexOf(" "+cookieName+"=");if(c_start===-1){c_start=c_value.indexOf(cookieName+"=");}
if(c_start===-1){c_value=null;}else{c_start=c_value.indexOf("=",c_start)+1;c_end=c_value.indexOf(";",c_start);if(c_end===-1){c_end=c_value.length;}
c_value=decodeURI(c_value.substring(c_start,c_end));}
return c_value;};getI18nMsg=function(dictionary,clientLang){var msg="";if(dictionary instanceof String||typeof dictionary=="string"){msg=dictionary;}else if(typeof dictionary==="object"){if(dictionary.hasOwnProperty(clientLang)){msg=dictionary[clientLang];}else if(dictionary.hasOwnProperty("default")){msg=dictionary["default"];}else{for(var k in dictionary){msg=dictionary[k];break;}}}
return msg;};getUrlVars=function(){var vars={};var parts=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(m,key,value){vars[key]=value;});return vars;};getUrlParam=function(parameter,defaultValue){var urlParameter=defaultValue;if(window.location.href.indexOf(parameter)>-1){urlParameter=getUrlVars()[parameter];}
return urlParameter;};var sw={sendConfigEvent:function(){sw.sendEvent("config",{"subscription":swSubscription,"backend":{"url":cfg.backend.url,"clientId":cfg.client.id,"clientApiKey":cfg.client.publicKey}});},sendEvent:function(event,payload){if(payload==undefined){payload={};}
if(swRegistration!=null&&swRegistration.active){swRegistration.active.postMessage(JSON.stringify({"event":event,"payload":payload}));}
return false;},showNotification:function(title,options){return new Promise(function(resolve,reject){if(!isInitialized||!isSupported){reject(new MinipushError("unsupported-browser",new Error("Unsupported")));return;}
if(swRegistration){swRegistration.showNotification(title,options).then(function(notificationEvent){resolve(notificationEvent);}).catch(function(e){reject(new MinipushError("unable-to-notify",e));});}else{reject(new MinipushError("service-worker-not-registered",new Error("serviceWorker not registered")));}});},isMinipushRegistration:function(registration){if(registration.active.scriptURL==cfg.serviceWorker.url)return true;if(registration.active.scriptURL==cfg.serviceWorker.oldUrl)return true;if(registration.active.scriptURL.match(/[^\/]*minipush[^\/]*\.js/i)!=null)return true;if(registration.active.scriptURL.match(/[^\/]*pushtide[^\/]*\.js/i)!=null)return true;return false;},getRegistration:function(){return new Promise(function(resolve,reject){if(!isInitialized||!isSupported){reject(new MinipushError("unsupported-browser",new Error("Unsupported")));return;}
var registrationFound=false;navigator.serviceWorker.getRegistrations().then(function(registrations){for(var registrationKey in registrations){var registration=registrations[registrationKey];if(registration.active&&sw.isMinipushRegistration(registration)){registrationFound=true;isRegistered=true;swRegistration=registration;resolve(registration);return;}}
if(!registrationFound){swRegistration=null;swSubscription=null;isRegistered=false;isSubscribed=false;resolve(null);}}).catch(function(){isRegistered=false;isSubscribed=false;swRegistration=null;swSubscription=null;reject(new MinipushError("unabe-to-get-registrations",new Error("Unable to get registered service workers")));});});},getSubscriptionValidationString:function(){return cfg.serviceWorker.url+"      "+cfg.serverPublicKey;},getSubscription:function(){return new Promise(function(resolve,reject){if(!isInitialized||!isSupported){reject(new MinipushError("unsupported-browser",new Error("Unsupported")));return;}
swSubscription=null;navigator.serviceWorker.getRegistrations().then(function(registrations){var registrationFound=false;for(var registrationKey in registrations){var registration=registrations[registrationKey];if(registration.active&&sw.isMinipushRegistration(registration)){registrationFound=true;isRegistered=true;swRegistration=registration;navigator.serviceWorker.ready.then(function(){swRegistration.pushManager.getSubscription().then(function(subscription){isSubscribed=swRegistration!=null&&subscription!=null;swSubscription=subscription;if(isSubscribed){}
resolve(subscription);return;}).catch(function(e){swSubscription=null;isSubscribed=false;reject(new MinipushError("unable-to-get-subscriptions",e));return;});});}}
if(!registrationFound){swRegistration=null;swSubscription=null;isRegistered=false;isSubscribed=false;resolve(null);return;}}).catch(function(e){isSubscribed=false;isRegistered=false;swRegistration=null;swSubscription=null;reject(new MinipushError("unabe-to-get-registrations",e));});});},subscribe:function(force,isAutoSubscribe){if(force==undefined)force=false;if(isAutoSubscribe==undefined)isAutoSubscribe=false;return new Promise(function(resolve,reject){if(!isInitialized||!isSupported){reject(new MinipushError("unsupported-browser",new Error("Unsupported")));return;}
if(isSubscribed&&!force){reject(new MinipushError("already-subscribed",new Error("Already subscribed")));return;}
isSubscribed=false;isRegistered=false;swRegistration=null;swSubscription=null;lastPermissionRequest=new Date();setCookie(cfg.cookies.prefix+cfg.cookies.request,lastPermissionRequest.getTime(),null,90);Notification.requestPermission().then(function(status){debug.log("sw.subscribe.permissions-"+status);if(status=="granted"){navigator.serviceWorker.register(cfg.serviceWorker.url).then(function(registration){debug.log("sw.subscribe.service-worker-registered");if(registration!=null){var onWorkerReady=function(){debug.log("ServiceWorker registered successfully: "+registration.active.scriptURL);swRegistration=registration;sw.sendEvent("register-sw");isRegistered=true;registration.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:cfg.serverPublicKey}).then(function(subscription){swSubscription=subscription;isSubscribed=true;if(minipushSubscription){minipushSubscription.doSubscribe(subscription,cfg.serverPublicKey,isAutoSubscribe);}
debug.log("Subscription completed successfully. Public key: "+cfg.serverPublicKey+" Endpoint: "+subscription.endpoint);resolve(subscription);cfg.events.onSubscribe(isAutoSubscribe);if(disclaimerMarkup){disclaimerMarkup.remove();}
if(bellButtonMarkup){bellButtonMarkup.remove();}
sw.sendConfigEvent();sw.sendEvent("subscribe");}).catch(function(e){debug.error("Unable to subscribe: "+e);reject(new MinipushError("unable-to-subscribe",e));});}
navigator.serviceWorker.ready.then(function(reg){var check=function(){if(reg.waiting!=null){debug.log("Waiting for new serviceworker... Current state "+reg.waiting.state)}
if(reg.active.scriptURL==cfg.serviceWorker.url){setTimeout(function(){onWorkerReady();},150);}else{setTimeout(check,500);}}
setTimeout(check,250);}).catch(function(e){debug.error("Unable to bring up the serviceWorker");reject(new MinipushError("unable-to-start-serviceworker",e));});}else{debug.error("Unable to register serviceWorker");reject(new MinipushError("unable-to-register-serviceworker",new Error("Unable to register serviceWorker")));}}).catch(function(e){debug.error("Unable to register serviceWorker: "+e);reject(new MinipushError("unable-to-register-serviceworker",e));});}else{debug.error("Permissions rejected: "+status);reject(new MinipushError("permissions-rejected",new Error("Permissions status: "+status)));}}).catch(function(e){reject(new MinipushError("cannot-get-permissions",e));});});},unsubscribe:function(){return new Promise(function(resolve,reject){isSubscribed=false;isRegistered=false;swSubscription=null;if(!isInitialized||!isSupported){reject(new MinipushError("unsupported-browser",new Error("Unsupported")));return;}
if(minipushSubscription){minipushSubscription.doUnsubscribe();}
navigator.serviceWorker.getRegistrations().then(function(registrations){var registrationFound=false;for(let registrationKey in registrations){var registration=registrations[registrationKey];if(registration.active&&sw.isMinipushRegistration(registration)){registrationFound=true;registration.pushManager.getSubscription().then(function(subscription){if(subscription!=null){sw.sendEvent("unsubscribe");subscription.unsubscribe().finally(function(){registration.unregister().finally(function(){swRegistration=null;sw.sendEvent("unregister-sw");resolve();});});}else{registration.unregister().finally(function(){swRegistration=null;sw.sendEvent("unregister-sw");resolve();});}}).catch(function(e){registration.unregister().finally(function(){swRegistration=null;sw.sendEvent("unregister-sw");resolve();});swRegistration=null;reject(new MinipushError("not-registered",e));});return;}}
if(!registrationFound){swRegistration=null;resolve();}}).catch(function(e){swRegistration=null;reject(new MinipushError("unable-to-get-registrations",e));});});}};if(window.addEventListener){window.addEventListener('load',function(){init();});}else{window.attachEvent('onload',function(){init();});}})();var MinipushError=function(status,error){this.status=status;this.error=error;};var MinipushSubscription=function(minipush,cfg){var self=this;var debug={log:function(msg){if(cfg.debug&&typeof console!="undefined"){if(msg instanceof Object){console.log("    %cMinipushSubscription "+Date.now()+": %c","color:#05B","color:#666",JSON.parse(JSON.stringify(msg)));}else{console.log("    %cMinipushSubscription "+Date.now()+": %c"+msg,"color:#05B","color:#666");}}},error:function(errorMsg){if(typeof console!="undefined"){console.error("    %cMinipushSubscription "+Date.now()+": %c"+errorMsg,"color:#05B","color:#f66");}}};var status={subscribed:false,dateSubscriptionStart:-1,dateSubscriptionTimeSinceStart:-1,dateSubscriptionLastVisit:-1,dateSubscriptionLastRefresh:-1,key:null,prevEndpoint:null,refreshRequired:false,isAutoSubscribe:false};var lastRefreshResponse="";var numRefreshes=0;var subscription=null;var version=0;var time=null;var intTime=null;var data={};var id="";var uid=null;var subscriptionData=null;var tags=[];var refreshTimeout=null;var isRefreshing=false;var providedKey=null;var expiredTags=false;var getUTCTime=function(){var myDate=new Date();return Math.round(myDate.getTime()/1000);};var getTime=function(){var myDate=new Date();return Math.round(myDate.getTime()/1000)+(myDate.getTimezoneOffset()*60);};var getLocalStorageName=function(baseName){if(cfg.localStorage.appendDbId){return baseName+"_"+cfg.client.id;}else{return baseName;}};var filterTag=function(tag){return tag=tag.split("|").join("-").split("/").join("-").split(" ").join("_").split("@").join("").toLowerCase().substring(0,30);};var getTagParts=function(tagString){var match,ttl;match=tagString.match(/^(.+)\|@([0-9]+)$/);if(match)tagString=match[1]+"|"+(parseInt(match[2])-getUTCTime());match=tagString.match(/^(.+)\|(\-?[0-9]+)$/);if(match){ttl=parseInt(match[2])
if(ttl>(86400*30))ttl=(86400*30);if(ttl<600)ttl=600;match[1]=filterTag(match[1]);tagString=match[1]+"|"+ttl;return[tagString,match[1],ttl];}
tagString=filterTag(tagString);return[tagString,tagString,0];};var loadData=function(firstLoad){if(firstLoad==undefined)firstLoad=false;var savedData=window.localStorage.getItem(getLocalStorageName("minipush"));if(savedData&&savedData[0]=="{"){savedData=JSON.parse(savedData);if(savedData.hasOwnProperty("version")){if(savedData.version!=cfg.version){debug.log("Version mismatch: saved version "+savedData.version+" != new version "+cfg.version);}
if(savedData.version<"0.3"&&cfg.version=="0.3"){}
version=savedData.version;}
if(savedData.hasOwnProperty("status")){if(savedData.status&&savedData.status.hasOwnProperty("subscribed")){for(var key in savedData.status){status[key]=savedData.status[key];}}}
if(savedData.hasOwnProperty("time")){time=savedData.time+"";intTime=parseInt(savedData.time);}
if(savedData.hasOwnProperty("id")){id=savedData.id+"";}
if(savedData.hasOwnProperty("data")){data=savedData.data;}
if(savedData.hasOwnProperty("tags")&&savedData.tags instanceof Array&&time>0){var utcTime=getUTCTime();var filteredTags=[];for(var i=0;i<savedData.tags.length;i++){var tagParts=getTagParts(savedData.tags[i]);if(tagParts[2]>0){if(utcTime<(intTime+tagParts[2])){filteredTags.push(tagParts[0]);}else{debug.log("Tag expired: "+tagParts[0]);expiredTags=true;}}else{filteredTags.push(tagParts[0]);}}
tags=filteredTags;}
if(savedData.hasOwnProperty("uid")){uid=savedData.uid;}
if(firstLoad){debug.log("Data loaded: version "+version);debug.log("Tags already present: "+JSON.stringify(tags));}}};var saveData=function(){window.localStorage.setItem(getLocalStorageName("minipush"),JSON.stringify({time:getUTCTime(),version:cfg.version,status:status,data:data,id:id,tags:tags,uid:uid}));minipush.setCookie(cfg.cookies.prefix+cfg.cookies.subscription,uid+"",null,90);expiredTags=false;};this.init=function(){debug.log("Init");loadData(true);};this.ready=function(swSubscription){debug.log("Ready");subscription=swSubscription;var justSubscribed=false;if(minipush.isSubscribed()){if(!status.subscribed){justSubscribed=true;debug.log("Forcing subscription");self.doSubscribe(minipush.swSubscription(),null,false);}}else{if(status.subscribed){debug.log("Forcing unsubscription");self.doUnsubscribe();}}
if(status.subscribed){status.dateSubscriptionTimeSinceStart=getTime()-status.dateSubscriptionStart;status.dateSubscriptionLastVisit=getTime();status.dateSubscriptionTimeSinceLastRefresh=getTime()-status.dateSubscriptionLastRefresh;if(expiredTags){self.refreshData(false,"ready-expired-tags");}
saveData();if(!justSubscribed){self.refreshData(false,"ready-trigger-visit");}}else{minipush.setCookie(cfg.cookies.prefix+cfg.cookies.subscription,null,null,-1);}};this.printUid=function(){self.getSubscriptionData().then(function(data){if(data&&typeof console!="undefined"){console.log("SUBSCRIPTION UID: "+data.id);console.log("SUBSCRIPTION DATA: "+JSON.stringify(data));}});};this.getUid=function(){return new Promise(function(resolve,reject){if(!minipush.isSubscribed()||subscription==null){resolve(null);}
if(numRefreshes==0){self.refreshData(true,"get-uid",function(){resolve(uid);});}else{resolve(uid);}});};this.getSubscriptionData=function(){return new Promise(function(resolve,reject){if(!minipush.isSubscribed()||subscription==null){resolve(null);}
if(numRefreshes==0){self.refreshData(true,"get-subscription-data",function(){resolve(subscriptionData);});}else{resolve(subscriptionData);}});};this.setId=function(newId){newId=newId+"";if(newId!=id){id=newId;saveData();if(status.subscribed){self.refreshData(true,"set-id");}}};this.getId=function(){return id;};this.setData=function(d){if(JSON.stringify(data)!=JSON.stringify(d)){data=d;saveData();if(status.subscribed){self.refreshData(true,"set-data");}}};this.getData=function(){return data;};this.inArray=function(arr,search){for(var i=0;i<arr.length;i++){if(arr[i]==search)return true;}
return false;};this.saveTags=function(newTags){if(!(newTags instanceof Array))throw new Error("Tags must be an array");tags=tags.slice(0,15);newTags=newTags.slice(0,15);tags.sort();newTags.sort();if(JSON.stringify(tags)!=JSON.stringify(newTags)){tags=newTags;saveData();if(status.subscribed){self.refreshData(true,"set-tags");}}};this.setTags=function(newTags){if(!(newTags instanceof Array))throw new Error("Tags must be an array");newTags=self.addTags(newTags.slice(0,15),true);return newTags;};this.addTags=function(tagsToAdd,overwrite){if(overwrite==undefined)overwrite=false;if(!(tagsToAdd instanceof Array))throw new Error("Not an array");var newTags=self.removeTags(tagsToAdd,true);var mergedTags=overwrite?[]:JSON.parse(JSON.stringify(newTags));for(var i=0;i<tagsToAdd.length;i++){var tagParts=getTagParts(tagsToAdd[i]);mergedTags.push(tagParts[0]);if(mergedTags.length>=15)break;}
self.saveTags(mergedTags);return mergedTags;};this.removeTags=function(tagsToRemove,doNotSave){if(doNotSave==undefined)doNotSave=false;if(!(tagsToRemove instanceof Array))throw new Error("Not an array");self.getTags();var newTags=[];for(var i=0;i<tags.length;i++){var found=false;var tag1Parts=getTagParts(tags[i]);for(var k=0;k<tagsToRemove.length;k++){var tag2Parts=getTagParts(tagsToRemove[k]);if(tag1Parts[1]==tag2Parts[1]){found=true;break;}}
if(!found&&newTags.length<20){newTags.push(tags[i]);}}
if(!doNotSave){self.saveTags(newTags);}
return newTags;};this.removeTagsByPrefix=function(tagsToRemove,doNotSave){if(doNotSave==undefined)doNotSave=false;if(!(tagsToRemove instanceof Array))throw new Error("Not an array");self.getTags();var newTags=[];for(var i=0;i<tags.length;i++){var found=false;var tag1Parts=getTagParts(tags[i]);for(var k=0;k<tagsToRemove.length;k++){var tag2Parts=getTagParts(tagsToRemove[k]);if(tag1Parts[1].substring(0,tag2Parts[1].length)==tag2Parts[1]){found=true;break;}}
if(!found&&newTags.length<20){newTags.push(tags[i]);}}
if(!doNotSave){self.saveTags(newTags);}
return newTags;};this.replaceTags=function(tagsToReplace,doNotSave){if(doNotSave==undefined)doNotSave=false;if(!(tagsToReplace instanceof Array))throw new Error("Not an array");var tagsToRemove=[];var tagsToAdd=[];self.getTags();var newTags=[];for(var i=0;i<tagsToReplace.length;i++){if(tagsToReplace[i]instanceof Array&&tagsToReplace[i].length>1){tagsToRemove.push(tagsToReplace[i][0]);tagsToAdd.push(tagsToReplace[i][1]);}}
newTags=self.removeTagsByPrefix(tagsToRemove);newTags=self.addTags(tagsToAdd,false);if(!doNotSave){self.saveTags(newTags);}
return newTags;};this.getTags=function(){loadData(false);return tags;};this.getBaseTags=function(){self.getTags();var baseTags=[]
for(var i=0;i<tags.length;i++){var tagParts=getTagParts(tags[i]);baseTags.push(tagParts[1]);}
return baseTags;};this.hasTag=function(tag){self.getTags();var tag1Parts=getTagParts(tag);for(var i=0;i<tags.length;i++){var tag2Parts=getTagParts(tags[i]);if(tag1Parts[1]==tag2Parts[1]){return true;}}
return false;};this.doSubscribe=function(swSubscription,key,isAutoSubscribe){if(!status.subscribed){debug.log("doSubscribe");subscription=swSubscription;status.subscribed=true;status.dateSubscriptionStart=getTime();status.key=key;status.isAutoSubscribe=isAutoSubscribe;providedKey=key;saveData();self.refreshData(true,"do-subscribe");}};this.doUnsubscribe=function(){if(status.subscribed){debug.log("doUnsubscribe");status.subscribed=false;status.dateSubscriptionStart=-1;saveData();self.refreshData(true,"do-unsubscribe",function(){uid=null;setTimeout(function(){saveData();},250);},null,true);}};var refreshDataOnCompletes=[];var refreshDataOnErrors=[];this.refreshData=function(forceRefresh,procedence,onComplete,onError,instant){if(instant==undefined)instant=false;if(onComplete==undefined)onComplete=function(){};if(onError==undefined)onError=function(){};if(procedence==undefined)procedence="unknown";if(forceRefresh==undefined)forceRefresh=false;var refreshRequired=status.refreshRequired||forceRefresh;var timeoutTime=(procedence=="do-subscribe"||procedence=="do-unsubscribe")?100:500;if(instant)timeoutTime=0;if(!refreshRequired){if(status.dateSubscriptionLastRefresh<(getTime()-cfg.backend.refreshRate)){refreshRequired=true;}}
var prevSubscription=window.localStorage.getItem(getLocalStorageName("minipush_prevsubscription"),false);if(prevSubscription&&subscription&&prevSubscription!=subscription.endpoint){refreshRequired=true;timeoutTime=0;}
if(!refreshRequired){debug.log("Refreshing data not required. Next refresh in "+((status.dateSubscriptionLastRefresh+cfg.backend.refreshRate)-getTime())+" seconds");return;}
debug.log("Refreshing data... (requested by "+procedence+")");refreshDataOnCompletes.push(onComplete);refreshDataOnErrors.push(onError);if(refreshTimeout){clearTimeout(refreshTimeout);}
refreshTimeout=setTimeout(function(){debug.log("Executing data refresh... (requested by "+procedence+")");status.refreshRequired=false;loadData();var body=JSON.stringify({status:status,id:id,uid:uid,data:data,tags:tags,subscription:subscription,prevSubscription:prevSubscription,clientApiKey:cfg.client.publicKey,clientId:cfg.client.id,version:cfg.version,serverPublicKey:JSON.stringify({"version":cfg.version,"autoSubscribe":status.isAutoSubscribe,"key":(status.key?status.key:cfg.serverPublicKey),"keyType":(status.key?"status.key":"cfg.serverPublicKey"),"providedKey":providedKey,"location":document.hostname})});fetch(cfg.backend.url+"?v="+cfg.version+"&r="+Math.random(),{headers:{'Content-type':'application/json'},method:'POST',body:body,}).then(function(data){isRefreshing=false;status.dateSubscriptionLastRefresh=getTime();status.dateSubscriptionTimeSinceLastRefresh=0;data.json().then(function(json){numRefreshes++;debug.log("Backend response <<<<<");debug.log(json);lastRefreshResponse=JSON.stringify(json);uid=null;subscriptionData=null;if(json&&json.hasOwnProperty("success")&&json.success){if(json&&json.hasOwnProperty("data")){if(json.data.hasOwnProperty("subscription")){uid=json.data.subscription;}
if(json.data.hasOwnProperty("subscriptionData")){subscriptionData=json.data.subscriptionData;if(json.data.subscriptionData.hasOwnProperty("client_tags_with_ttls"))tags=subscriptionData.client_tags_with_ttls;}
if(json.data.hasOwnProperty("subscription")){uid=json.data.subscription;}
if(json&&json.data.hasOwnProperty("pingSuccess")&&!json.data.pingSuccess){debug.error("Ping couldn't be sent, unsubscribing right now!");setTimeout(function(){minipush.subscription.unsubscribe();},1000);}}}else if(json&&json.hasOwnProperty("errorMessage")){uid=null;subscriptionData=null;status.dateSubscriptionLastRefresh=-1;debug.error("cannot-post-to-backend: "+json.errorMessage);}
saveData();window.localStorage.setItem(getLocalStorageName("minipush_prevsubscription"),subscription?subscription.endpoint:null);for(var i=0;i<refreshDataOnCompletes.length;i++){refreshDataOnCompletes[i]();}
refreshDataOnCompletes=[];refreshDataOnErrors=[];}).catch(function(e){lastRefreshResponse="Error "+e.message+": "+JSON.stringify(data.statusText);debug.error("cannot-post-to-backend: "+e.message+" | "+data.statusText);debug.log(data);uid=null;status.dateSubscriptionLastRefresh=-1;subscriptionData=null;saveData();for(var i=0;i<refreshDataOnCompletes.length;i++){refreshDataOnCompletes[i]();}
for(var i=0;i<refreshDataOnErrors.length;i++){refreshDataOnErrors[i]();}
refreshDataOnCompletes=[];refreshDataOnErrors=[];});}).catch(function(e){lastRefreshResponse="Error: "+JSON.stringify(e);debug.error("cannot-post-to-backend: "+JSON.stringify(e));uid=null;subscriptionData=null;status.dateSubscriptionLastRefresh=-1;saveData();for(var i=0;i<refreshDataOnCompletes.length;i++){refreshDataOnCompletes[i]();}
for(var i=0;i<refreshDataOnErrors.length;i++){refreshDataOnErrors[i]();}
refreshDataOnCompletes=[];refreshDataOnErrors=[];});saveData();},timeoutTime);};self.init();};